#! /bin/sh
# postinst script for burnstation
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#

case "$1" in
    configure)

chmod 777 /var/spool/burnstation
chmod 777 /var/log/burnstation
chmod 755 /usr/share/burnstation-client-2.0/burn.py

# FIXME we exit here because this post installation script is disabled
exit 0

writeconf()
{
	cp /etc/burnstation/burnstation.conf /etc/burnstation/burnstation.conf-pre-dpkg-upgrade
	echo "[*] A backup of your config was saved as /etc/burnstation/burnstation.conf-pre-dpkg-upgrade"
	sed "s#^DBhost.*#DBhost = $DBhost#" \
	/usr/share/doc/burnstation-client-2.0/examples/burnstation.conf \
	| sed "s#^webUrl.*#webUrl = $webUrl#"\
	> /etc/burnstation/burnstation.conf
	
	echo "[*] New config file was written as /etc/burnstation/burnstation.conf"
	echo ""
	echo "[!] You might want to compare those two files to adapt your config accordingly"
}

confirm()
{
	echo -n "Are those settings correct? [y/n] : "
	read confirm

	case "$confirm" in
	y)
		writeconf
		echo ""
		echo "Thanks! I've fixed the settings in /etc/burnstation/burnstation.conf"
		echo "Please, check this file again in the case of problems."
		echo ""
		echo "Have a lot of fun!"
		;;
	n)
		welcome
		;;
	*)
		;;
	esac
}

welcome()
{
	confirm=""
	defaultDBhost="localhost"
	
	echo ""
	echo "------------------------------------------------------------------------------"
	echo "Welcome to burnstation installation!"
	echo "I will help you to setup the configuration for your burnstation.."
	echo ""
	echo "Please, answer the following questions:"
	echo ""
	echo -n "* Tell me the hostname or IP address for the burnstation database server [localhost] : "
	read DBhost
	
	if [ ! "$DBhost" ]
	then
		DBhost=$defaultDBhost
	fi
	
	echo "- thanks, using $DBhost to access the burnstation database.."
	echo ""
	echo "* Tell me the URL to access the web contents (including http://)"
	echo -n "if it is the same as above, just press enter [http://$DBhost/burnstation] : "
	read webUrl

	if [ ! "$webUrl" ]; then
		echo "web contents URL not specified, using same as database server.."
		webUrl="http://$DBhost/burnstation"
	else
		echo "- thanks, using $webUrl to access the burnstation web contents.."
	fi
	
	echo ""
	echo "Confirm the following:"
	echo ""
	echo "Database host : $DBhost"
	echo "Web URL : $webUrl"
	echo ""
	
	confirm
}

checkconf()
{
	CONFFILE=/etc/burnstation/burnstation.conf
	if [ -e $CONFFILE ]
	then
		echo "* $CONFFILE found, not re-configuring"
		exit 0
	else
		echo "* $CONFFILE not found, starting configuration"
		welcome
	fi
}

#checkconf # as we changed the conf file format to be parsed by PHP we force writing a new one
welcome

	
	while [ "$confirm" = "" ]
	do
		echo ""
		echo "You must answer \"y\" or \"n\" to the following question:"
		confirm
	done
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
	echo "some kind of abort ocurred, try something else"

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0


